<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>The Game of Life</title>

<style>

body{
  margin-left: 60px;
  text-align: center;
  color: black;
  font-size: 24px;
}

.row {
  display: flex;
  flex-direction: row;
}

.pixel:hover {
  box-shadow: 0px 0px 0px 3px red inset;
}


#sidebar {
  right: 0%;
  top:0%;
  margin: 100px 140px;
  position:absolute;
  display: flex;
  flex-direction:column;
}

input {
  height: 45px;
  width: 250px;
  font-size: 24px;
  background-color: transparent;
  border: RGB(230,230,230) 2px solid;
}

input:focus::placeholder {
  color: transparent;
}


.field-label {
  border: RGB(230,230,230) 0px solid;
  text-align: left;
}

.field-text {
  text-align: center;
  color: black;
  background-color: lightgray;
  margin: 10px 20px;
}

.field-text:hover {
  border:  2px solid steelblue;
}

.sideButton {
  margin: 10px 20px;
  cursor: pointer;
  text-align: center;
  color: black;
  background-color: lightgray;
  height: 50px;
  width: 260px;
}

#runButton{
  height: 80px;
}

.sideButton:hover {
  border:  2px solid steelblue;
}

</style>
</head>

<body>
  <h2>The Game of Life: With Parameters</h2>
  <div id="chart"></div>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.js" type="text/javascript"></script>
<script>

var id = -1;
var data = new Array();
var boardSize = 110;
var animate = null;
var chartDim = 650;
var pixDim = chartDim / boardSize;


clearMap();
randMap();

function clearMap(){
  for (i=0;i<boardSize;i++) {
      data[i]=new Array();
    for (j=0;j<boardSize;j++) {
      data[i][j]=0;
    }
  }
  updateElem(data);
}

function randMap(){
  for (i=0;i<boardSize;i++) {
    for (j=0;j<boardSize;j++) {
      data[i][j] = Math.random()<.15 ? 1 : 0
    }
  }
  updateElem(data);
}


function makeNeighbors(x) {
  var n = []
  for (let i = -1 * x; i < x + 1; i++){
    for (let j = -1 * x; j < x + 1; j++){
      if (!(i == 0 && j == 0) && (x == 1 || i**2 + j**2 <= x ** 2)){
        n.push([i,j])
      }
    }
  }
  return n
}


var row = d3.select("#chart")
  .selectAll(".row")
    .data(data)
  .enter().append("div")
    .attr("class","row")

var pixel = row
    .selectAll(".pixel")
        .data(function(d) { return d; })
      .enter().append("div")
        .attr("class","pixel")
        .style("height", pixDim + "px")
        .style("width", pixDim + "px")
        .style("background-color",function(d) {return d ? "steelblue" : "white"})
        .attr("id",function(){id++; return "["+Math.floor(id/boardSize)+","+ id%boardSize+"]"})
        .on("click", function() {
          var y = eval(this.id)[0]
          var x = eval(this.id)[1]
          d3.select(this)
            .style("background-color", data[y][x]? "white" : "steelblue");
          data[y][x]=1-data[y][x];
        })


function updateElem(data){
  d3.selectAll(".row")
      .data(data)
    .selectAll(".pixel")
      .data(function(d) {return d; })
    .transition()
      .duration(200)
      .style("background-color",function(d) {return d ? "steelblue" : "white"})
}

function modNumber(a,b){
  if (a >= 0){
    return a % b;
  } else {
    return b + a;
  }

}

function newDatum(a,b) {
  var allNeighbors = neighbors.map(function(x) {
    a = Number(a)
    b = Number(b)
    let c = x[0]
    let d = x[1]
    try {
      map = data[modNumber(a+c,boardSize)][modNumber(b+d,boardSize)]
      return isFinite(map) ? map : 0}
    catch(err){
      return 0}
    ;})
  var numNeighbors = allNeighbors.reduce(function(sum,value) {return sum + value; }, 0);
  if (data[i][j]) {
    return live.includes(numNeighbors) ? 1 : 0
  } else {
    if (spawn != 0) {
      let x = Math.random()
      if (x < spawn){
        return 1
      }
    }
    return birth.includes(numNeighbors) ? 1 : 0
  }
}


function updateData(data1){
  var data2 = _.cloneDeep(data1)
  for (i in data1){
    for (j in data1){
      data2[i][j]=newDatum(i,j);
    }
  }
  return data2;
}


var sidebar = d3.select("body").append("div")
    .attr("id","sidebar")


function handleClick(e){
  var keyCode = e.keyCode ? e.keyCode : e.which;
  if (keyCode === 13){
    console.log(13);
    updateValues();
    stopStartFunction();
  }
}

function fieldMaker(rowType){
  var d = fieldDict[rowType]
  var thisRow = sidebar.append("div")
    .attr("id",rowType + "Row")
    .attr("onkeypress","handleClick(event)")
    
  thisRow.append("input")
    .attr("type","button")
    .attr("class","field-label")
    .attr("id",rowType + "Button")
    .attr("value",d.labelText)

    
  thisRow.append("input")
    .attr("type","text")
    .attr("class","field-text")
    .attr("id",rowType + "TextBox")
    .attr("placeholder",d.placeholder)
    
  return thisRow
}

const fieldDict = {
  "birth" : {
    labelText : 'Birth conditions:',
    placeholder: "3"
  },  
  "life" : {
    labelText : 'Life conditions:',
    placeholder: "2,3"
  },  
  "radius" : {
    labelText : 'Neighborhood radius:',
    placeholder: "1"
  },    
  "spawn" : {
    labelText : 'Spontaneity:',
    placeholder: "0.00"
  },
  "speed" : {
    labelText : 'Speed (fps):',
    placeholder: "2"
  }
}

for (row in fieldDict){
  fieldMaker(row)
}











sidebar.append("div")
    .attr("id","randRow")
    // .style("margin-top","20px")


var randLabel = d3.select("#randRow")
.append("input")
  .attr("type","button")
  .attr("class","field-label")


var randField = d3.select("#randRow")
.append("input")
  .attr("type","button")
  .attr("class","sideButton")
  .attr("id","randButton")
  .attr("placeholder","3")
  .attr("value","Random")
    .on("click",function() {
      randMap();
    })


sidebar.append("div")
    .attr("id","clearRow")


var clearLabel = d3.select("#clearRow")
.append("input")
  .attr("type","button")
  .attr("class","field-label")


var clearField = d3.select("#clearRow")
.append("input")
.attr("type","button")
.attr("class","sideButton")
.attr("id","clearButton")
.attr("value","Clear")
.on("click",function() {
  clearMap();
  if (runButton.attr("value") != "Run"){
    stopStartFunction();
  }
  })


sidebar.append("div")
    .attr("id","runRow")


var runLabel = d3.select("#runRow")
.append("input")
  .attr("type","button")
  .attr("class","field-label")


function updateValues (){
  alert(3)
  fps = document.getElementById("speedTextBox").value || 2
      radius = parseInt(document.getElementById("radiusTextBox").value) || 1
      spawn = document.getElementById("spawnTextBox").value || 0


      birthRaw = document.getElementById("birthTextBox").value
      birth = birthRaw ? birthRaw.split(",").map(x => +x) : [3]
      
      liveRaw = document.getElementById("lifeTextBox").value
      live = liveRaw ? liveRaw.split(",").map(x => +x) : [2,3]
      
      neighbors = makeNeighbors(radius)
      reloadSpeed = 1000 / fps

}


var runButton = d3.select("#runRow")
  .append("input")
    .style("margin-top","60px")
    .attr("id","runButton")
    .attr("type","button")
    .attr("class","sideButton")
    .attr("value","Run")
    .on("click", function(){
      updateValues()

      stopStartFunction();
    })
    

stopStartFunction = function(){
  animate ? stop() : start();
  change();
}

function start(){
  data = updateData(data);
  updateElem(data);
  animate = setTimeout(start,reloadSpeed);
}

change = function() {
  runButton.attr("value",function(){
    return runButton.attr("value") === "Run" ? "Stop" : "Run"
  });
}

stop = function(){
  clearTimeout(animate)
  animate = null;
}
</script>
</body>
</html>